# MailHardener DMARC Report Analysis

A PowerShell script that processes MailHardener HTML reports and generates consolidated summary reports with enhanced visualization and client-based grouping.

For MSPs that are working to move their DMARC-aligned clients to `quarantine` or `reject` mode from `none` after DMARC is initially configured. This script provides sorting and grouping by DMARC Status to make it easier to identify clients that need to be moved to `quarantine` or `reject` mode after verifying the configuration and ensuring all legitimate email sources are DMARC-aligned via DKIM and/or SPF.

The report output links to the proper section of the MailHardener dashboard for each domain, making it easy to navigate to the correct section for each domain to review and update status.

Getting a DMARC record created is important to allow email delivery to most major email domains today, but even if the records exist, if the mode is set to `none` no action will be taken on spoofed email. This mode is designed for testing and verification purposes, but doesn't provide any actual protection against spoofed email. Once the DMARC record is created and the mode is set to `quarantine` or `reject`, any email that fails DMARC alignment will be quarantined or rejected, respectively, or at least the receiving server is recommended to take one of those actions.

Ensure that all legitimate sending email sources for a domain are properly DMARC-aligned before changing the DMARC mode to `quarantine` or `reject` or legitimate email will likely not be delivered properly! It's possible to set a percentage of unaligned email to follow the `quarantine` or `reject` action, but all-or-nothing is much preferred once source verification is completed, especially for senders with comparatively small email volumes.

The [MailHardener Knowledgebase](https://www.mailhardener.com/kb/) provides additional information about DMARC and how to configure it, along with the various components that are used to configure DMARC.

Note that although MailHardener provides MTA-STS, TLSRPT, and BIMI hosting and/or monitoring, the former two are displayed only for reference and the BIMI status is ignored entirely, as it's only relevant for organizations that both have a trademark and are willing to buy a BIMI certificate. This gets cost-prohibitive for small organizations.

MTA-STS and TLSRPT are two different options to help validate or enforce the use of TLS encryption for email delivery. MTA-STS is a policy statement that can be published in a DNS record (alongside a required web server component), while TLSRPT is a reporting mechanism that can be used to collect data about the use of TLS encryption for email delivery.

For optimum security both are recommended, but due to the risks of breakage for an extended period of time (due to long time-to-live refresh values) should the configuration change, very careful consideration of long-term settings and impact should be made before implementing either of these for a given domain.

**NOTE**: This script was written based on the reports from the "Large" pricing plan from MailHardener, and is likely to work on the Standard and Enterprise plans but is untested. The multi-tenant/MSP plan may require script changes to parse and handle the output properly, and this has **not** been tested.

## Version

- 1.0.0 - 2025-07-17 - Initial release

## Author

David Szpunar (https://github.com/dszp and https://dszp.dev)

## Overview

This script analyzes MailHardener HTML reports to create:
- **Index Page**: A centralized dashboard listing all generated reports organized by year and month
- **Individual Summary Reports**: Enhanced HTML reports for each time period with improved formatting, navigation, and client grouping

## Features

- **Client-Based Grouping**: When `clientmapping.csv` exists, domains are grouped by client name within each DMARC status section
- **Enhanced Navigation**: Each report includes a "Back to Reports Index" link for easy navigation
- **Report Generation Timestamps**: Each report displays when it was generated
- **DMARC Status Visualization**: Color-coded status indicators and summary counts
- **Interactive DataTables**: Sortable, filterable tables with collapsible client name groupings
- **Responsive Design**: Modern, mobile-friendly interface
- **Fully static output with self-contained HTML, CSS, and JS**: No dependencies on external resources after report generation, can view directly in local web browser.

## Requirements

- **PowerShell 7.0+** (cross-platform support)
- **Internet Connection** (for downloading HtmlAgilityPack dependency if not present locally)
- **HTML Reports** Generated by MailHardener on the Domain Reports page. Choose the Period you wish to download the report for, then click the "Download as HTML" button and save the file to the `./data` directory under this script. Save as many reports as you'd like in individual files, with the default names provided by MailHardener, for example `report April 2025.html` and `report May 2025.html`. All reports will be processed and a summary report will be generated for each report, each time the script is run.

## Directory Structure

```
MailHardener-Report-Analysis/
├── Create-MailHardenerReport.ps1    # Main script
├── data/                            # Input data directory
│   ├── *.html                      # MailHardener HTML reports
│   └── clientmapping.csv           # Optional client mapping file
├── analysis/                       # Output directory
│   ├── index.html                  # Generated index page
│   └── *-Summary.html              # Generated summary reports
└── bin/                           # Dependencies (auto-created)
    └── HtmlAgilityPack.dll        # HTML parsing library (and related files)
```

## Usage

### Basic Usage

```powershell
# Run with default settings
./Create-MailHardenerReport.ps1

# Run with verbose output
./Create-MailHardenerReport.ps1 -Verbose
```

### Advanced Usage

```powershell
# Specify custom paths
./Create-MailHardenerReport.ps1 -DataPath "C:\Reports\Data" -AnalysisPath "C:\Reports\Output"

# Use custom client mapping file
./Create-MailHardenerReport.ps1 -ClientMappingPath "C:\Config\clients.csv"
```

### Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `-DataPath` | Path to folder containing HTML reports | `./data` |
| `-AnalysisPath` | Path where summary reports will be saved | `./analysis` |
| `-ClientMappingPath` | Path to client mapping CSV file | `./data/clientmapping.csv` |

## Client Mapping

To enable client-based grouping, create a `clientmapping.csv` file in the data directory:

```csv
ClientName,Domain
Acme Inc,acme.com
Widgets Inc,widgets.com
Bicycles R Us,bicyclesrus.com
Bicycles R Us,bicyclesrus.org
Software Solutions,softwaresolutions.com
Software Solutions,softwaresolutions.net
```

**Benefits of Client Mapping:**
- Domains belonging to the same client are grouped together within each DMARC status section
- Improves report readability for multi-domain clients
- Maintains alphabetical sorting within client groups

## Output

### Individual Summary Reports
- **File Format**: `[original-filename]-Summary.html`
- **Content**: Enhanced version of original report with:
  - Navigation link back to index
  - Report generation timestamp
  - Client-based domain grouping (if mapping exists)
  - Interactive DataTables with sorting/filtering
  - DMARC status summaries and color coding

### Index Page
- **File**: `index.html`
- **Content**: Centralized dashboard with:
  - Hierarchical listing of all reports (by year/month)
  - Direct links to individual reports
  - Generation timestamp and report counts

## Report Information

Each generated report includes:

- **Aggregated Period**: Time range covered by the report
- **DMARC Report Info**: Details about DMARC reporting data
- **Report Generated**: Timestamp when the summary was created

## Dependencies

The script automatically manages its dependencies:
- **HtmlAgilityPack**: Downloaded automatically from NuGet if not present locally (to `./bin` directory)
- **PowerShell 7.0+**: Required for cross-platform compatibility

## Troubleshooting

### Common Issues

1. **No HTML files found**: Ensure MailHardener reports are in the `data` directory
3. **Network issues**: Ensure internet connectivity for dependency download

### Verbose Output

Use the `-Verbose` parameter to see detailed processing information:
```powershell
./Create-MailHardenerReport.ps1 -Verbose
```

## Output Example

```
Successfully generated summary report: ./analysis/report April 2025-Summary.html
Successfully generated summary report: ./analysis/report May 2025-Summary.html
Generated index.html: ./analysis/index.html
All reports generated successfully!
```

## Notes

- **Client Mapping**: Optional feature that enhances report organization
- **Cross-Platform**: Works on Windows, macOS, and Linux with PowerShell 7+

## Screenshots of Output

Example of report index page:
![Report Index](<./img/index-example.png>)

Example of report page (truncated):
![Report Example](<./img/report-example.png>)
